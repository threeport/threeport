package root

import (
	"fmt"

	. "github.com/dave/jennifer/jen"
	"github.com/iancoleman/strcase"

	"github.com/threeport/threeport/internal/sdk"
	"github.com/threeport/threeport/internal/sdk/gen"
	"github.com/threeport/threeport/internal/sdk/util"
	cli "github.com/threeport/threeport/pkg/cli/v0"
)

// GenMagefile generates the source code for mage which is a Make-like tool
// using Go.
// Ref: https://github.com/magefile/mage
func GenMagefile(gen *gen.Generator, sdkConfig *sdk.SdkConfig) error {
	f := NewFile("main")
	f.HeaderComment("generated by 'threeport-sdk gen' - do not edit")

	f.PackageComment("+build mage")

	f.ImportAlias("github.com/threeport/threeport/pkg/util/v0", "util")

	// capture function names for each component
	buildApiFuncName := "BuildApi"
	buildDbMigratorFuncName := "BuildDbMigrator"
	buildFuncNames := []string{buildApiFuncName, buildDbMigratorFuncName}

	buildApiImageFuncName := "BuildApiImage"
	buildDbMigratorImageFuncName := "BuildDbMigratorImage"
	buildImageFuncNames := []string{buildApiImageFuncName, buildDbMigratorImageFuncName}

	buildValsFuncName := "getBuildVals"

	// binary build function for API
	f.Comment(fmt.Sprintf("%s builds the REST API binary.", buildApiFuncName))
	f.Func().Id(buildApiFuncName).Params().Error().Block(
		List(Id("workingDir"), Id("arch"), Err()).Op(":=").Id(buildValsFuncName).Call(),
		If(Err().Op("!=").Nil()).Block(
			Return().Qual("fmt", "Errorf").Call(Lit("failed to get build values: %w"), Err()),
		),
		Line(),

		If(Err().Op(":=").Qual(
			"github.com/threeport/threeport/pkg/util/v0",
			"BuildBinary",
		).Call(
			Line().Id("workingDir"),
			Line().Id("arch"),
			Line().Lit("rest-api"),
			Line().Lit("cmd/rest-api/main_gen.go"),
			Line().Lit(false),
			Line(),
		).Op(";").Err().Op("!=").Nil()).Block(
			Return().Qual("fmt", "Errorf").Call(
				Lit("failed to build rest-api binary: %w"),
				Err(),
			),
		),
		Line(),

		Qual("fmt", "Println").Call(Lit("binary built and available at bin/rest-api")),
		Line(),

		Return().Nil(),
	)
	f.Line()

	// image build and push function for API
	apiImageName := "threeport-rest-api"
	if gen.Extension {
		apiImageName = fmt.Sprintf(
			"threeport-%s-rest-api",
			strcase.ToSnake(sdkConfig.ExtensionName),
		)
	}
	f.Comment(fmt.Sprintf("%s builds and pushes a development REST API image.", buildApiImageFuncName))
	f.Func().Id(buildApiImageFuncName).Params().Parens(Error()).Block(
		List(Id("workingDir"), Id("arch"), Err()).Op(":=").Id(buildValsFuncName).Call(),
		If(Err().Op("!=").Nil()).Block(
			Return(Qual("fmt", "Errorf").Call(Lit("failed to get build values: %w"), Err())),
		),
		Line(),

		If(Err().Op(":=").Qual(
			"github.com/threeport/threeport/pkg/util/v0",
			"BuildImage",
		).Call(
			Line().Id("workingDir"),
			Line().Lit("cmd/rest-api/image/Dockerfile-alpine"),
			Line().Id("arch"),
			Line().Lit("localhost:5001"),
			Line().Lit(apiImageName),
			Line().Lit("dev"),
			Line().True(),
			Line().False(),
			Line().Lit(""),
			Line(),
		), Err().Op("!=").Nil()).Block(
			Return(Qual("fmt", "Errorf").Call(Lit("failed to build and push rest-api image: %w"), Err())),
		),
		Line(),

		Return(Nil()),
	)
	f.Line()

	// binary build function for database migrator
	f.Comment(fmt.Sprintf("%s builds the database migrator binary.", buildDbMigratorFuncName))
	f.Func().Id(buildDbMigratorFuncName).Params().Error().Block(
		List(Id("workingDir"), Id("arch"), Err()).Op(":=").Id(buildValsFuncName).Call(),
		If(Err().Op("!=").Nil()).Block(
			Return().Qual("fmt", "Errorf").Call(Lit("failed to get build values: %w"), Err()),
		),
		Line(),

		If(Err().Op(":=").Qual(
			"github.com/threeport/threeport/pkg/util/v0",
			"BuildBinary",
		).Call(
			Line().Id("workingDir"),
			Line().Id("arch"),
			Line().Lit("database-migrator"),
			Line().Lit("cmd/database-migrator/main_gen.go"),
			Line().Lit(false),
			Line(),
		).Op(";").Err().Op("!=").Nil()).Block(
			Return().Qual("fmt", "Errorf").Call(
				Lit("failed to build database-migrator binary: %w"),
				Err(),
			),
		),
		Line(),

		Qual("fmt", "Println").Call(Lit("binary built and available at bin/database-migrator")),
		Line(),

		Return().Nil(),
	)
	f.Line()

	// image build and push function for database migrator
	dbMigratorImageName := "threeport-database-migrator"
	if gen.Extension {
		dbMigratorImageName = fmt.Sprintf(
			"threeport-%s-database-migrator",
			strcase.ToSnake(sdkConfig.ExtensionName),
		)
	}
	f.Comment(fmt.Sprintf("%s builds and pushes a development database migrator image.", buildDbMigratorImageFuncName))
	f.Func().Id(buildDbMigratorImageFuncName).Params().Parens(Error()).Block(
		List(Id("workingDir"), Id("arch"), Err()).Op(":=").Id(buildValsFuncName).Call(),
		If(Err().Op("!=").Nil()).Block(
			Return(Qual("fmt", "Errorf").Call(Lit("failed to get build values: %w"), Err())),
		),
		Line(),

		If(Err().Op(":=").Qual(
			"github.com/threeport/threeport/pkg/util/v0",
			"BuildImage",
		).Call(
			Line().Id("workingDir"),
			Line().Lit("cmd/database-migrator/image/Dockerfile-alpine"),
			Line().Id("arch"),
			Line().Lit("localhost:5001"),
			Line().Lit(dbMigratorImageName),
			Line().Lit("dev"),
			Line().True(),
			Line().False(),
			Line().Lit(""),
			Line(),
		), Err().Op("!=").Nil()).Block(
			Return(Qual("fmt", "Errorf").Call(Lit("failed to build and push database-migrator image: %w"), Err())),
		),
		Line(),

		Return(Nil()),
	)
	f.Line()

	// binary build functions for controllers
	for _, objGroup := range gen.ApiObjectGroups {
		if len(objGroup.ReconciledObjects) > 0 {
			// binary build function
			buildFuncName := fmt.Sprintf("Build%sController", objGroup.ControllerDomain)
			buildFuncNames = append(buildFuncNames, buildFuncName)

			f.Comment(fmt.Sprintf(
				"%s builds the binary for the %s.",
				buildFuncName,
				objGroup.ControllerName,
			))
			f.Func().Id(buildFuncName).Params().Error().Block(
				List(Id("workingDir"), Id("arch"), Err()).Op(":=").Id(buildValsFuncName).Call(),
				If(Err().Op("!=").Nil()).Block(
					Return().Qual("fmt", "Errorf").Call(Lit("failed to get build values: %w"), Err()),
				),
				Line(),

				If(Err().Op(":=").Qual(
					"github.com/threeport/threeport/pkg/util/v0",
					"BuildBinary",
				).Call(
					Line().Id("workingDir"),
					Line().Id("arch"),
					Line().Lit(objGroup.ControllerName),
					Line().Lit(fmt.Sprintf("cmd/%s/main_gen.go", objGroup.ControllerName)),
					Line().Lit(false),
					Line(),
				).Op(";").Err().Op("!=").Nil()).Block(
					Return().Qual("fmt", "Errorf").Call(
						Lit(fmt.Sprintf("failed to build %s binary: %%w", objGroup.ControllerName)),
						Err(),
					),
				),
				Line(),

				Qual("fmt", "Println").Call(Lit(
					fmt.Sprintf("binary built and available at bin/%s", objGroup.ControllerName),
				)),
				Line(),

				Return().Nil(),
			)
			f.Line()

			// image build and push function
			buildImageFuncName := fmt.Sprintf("Build%sControllerImage", objGroup.ControllerDomain)
			buildImageFuncNames = append(buildImageFuncNames, buildImageFuncName)

			f.Comment(fmt.Sprintf(
				"%s builds and pushes the container image for the %s.",
				buildImageFuncName,
				objGroup.ControllerName,
			))
			f.Func().Id(buildImageFuncName).Params().Error().Block(
				List(Id("workingDir"), Id("arch"), Err()).Op(":=").Id(buildValsFuncName).Call(),
				If(Err().Op("!=").Nil()).Block(
					Return(Qual("fmt", "Errorf").Call(Lit("failed to get build values: %w"), Err())),
				),
				Line(),

				If(Err().Op(":=").Qual(
					"github.com/threeport/threeport/pkg/util/v0",
					"BuildImage",
				).Call(
					Line().Id("workingDir"),
					Line().Lit(fmt.Sprintf("cmd/%s/image/Dockerfile-alpine", objGroup.ControllerName)),
					Line().Id("arch"),
					Line().Lit("localhost:5001"),
					Line().Lit(fmt.Sprintf("threeport-%s", objGroup.ControllerName)),
					Line().Lit("dev"),
					Line().True(),
					Line().False(),
					Line().Lit(""),
					Line(),
				), Err().Op("!=").Nil()).Block(
					Return(Qual("fmt", "Errorf").Call(
						Lit(fmt.Sprintf(
							"failed to build and push %s image: %%w",
							objGroup.ControllerName,
						)),
						Err(),
					)),
				),
				Line(),

				Return(Nil()),
			)
			f.Line()
		}
	}
	f.Line()

	// build all binaries
	buildAllFuncName := "BuildAll"
	f.Comment(fmt.Sprintf("%s builds the binaries for all components.", buildAllFuncName))
	f.Func().Id(buildAllFuncName).Params().Error().BlockFunc(func(g *Group) {
		for _, funcName := range buildFuncNames {
			g.If(Err().Op(":=").Id(funcName).Call().Op(";").Err().Op("!=").Nil()).Block(
				Return().Qual("fmt", "Errorf").Call(
					Lit("failed to build binary: %w"),
					Err(),
				),
			)
			g.Line()
		}

		g.Return().Nil()
	})

	// build and push all images
	buildAllImagesFuncName := "BuildAllImages"
	f.Comment(fmt.Sprintf("%s builds and pushes images for all components.", buildAllImagesFuncName))
	f.Func().Id(buildAllImagesFuncName).Params().Error().BlockFunc(func(g *Group) {
		for _, funcName := range buildImageFuncNames {
			g.If(Err().Op(":=").Id(funcName).Call().Op(";").Err().Op("!=").Nil()).Block(
				Return().Qual("fmt", "Errorf").Call(
					Lit("failed to build and push image: %w"),
					Err(),
				),
			)
			g.Line()
		}

		g.Return().Nil()
	})

	// image loads to kind clusters
	f.Comment("LoadImage builds and loads an image to the provided kind cluster.")
	f.Func().Id("LoadImage").Params(
		Id("kindClusterName").String(),
		Id("component").String(),
	).Error().BlockFunc(func(g *Group) {
		g.List(Id("workingDir"), Id("arch"), Id("err")).Op(":=").Id("getBuildVals").Call()
		g.If(Id("err").Op("!=").Nil()).Block(
			Return(Qual("fmt", "Errorf").Call(Lit("failed to get build values: %w"), Id("err"))),
		)
		g.Line()

		g.Id("imageName").Op(":=").Qual("fmt", "Sprintf").Call(Lit("threeport-%s"), Id("component"))
		if gen.Extension {
			g.If(Id("component").Op("==").Lit("rest-api")).Block(
				Id("imageName").Op("=").Qual("fmt", "Sprintf").Call(
					Lit("threeport-%s-%s"),
					Lit(strcase.ToSnake(sdkConfig.ExtensionName)),
					Id("component"),
				),
			)
		}
		g.Line()

		g.If(Err().Op(":=").Qual(
			"github.com/threeport/threeport/pkg/util/v0",
			"BuildImage",
		).Call(
			Line().Id("workingDir"),
			Line().Qual("fmt", "Sprintf").Call(Lit("cmd/%s/image/Dockerfile-alpine"), Id("component")),
			Line().Id("arch"),
			Line().Lit("localhost:5001"),
			Line().Id("imageName"),
			Line().Lit("dev"),
			Line().False(),
			Line().True(),
			Line().Id("kindClusterName"),
			Line(),
		).Op(";").Err().Op("!=").Nil()).Block(
			Return(Qual("fmt", "Errorf").Call(Lit("failed to build and load image: %w"), Id("err"))),
		)
		g.Line()

		g.Return(Nil())
	})
	f.Line()

	// extension plugin build
	if gen.Extension {
		f.Comment("BuildPlugin compiles the extension's tptctl plugin")
		f.Func().Id("BuildPlugin").Params().Error().Block(
			Id("buildCmd").Op(":=").Qual("os/exec", "Command").Call(
				Line().Lit("go"),
				Line().Lit("build"),
				Line().Lit("-o"),
				Line().Lit(fmt.Sprintf(
					"bin/%s.so",
					strcase.ToKebab(sdkConfig.ExtensionName),
				)),
				Line().Lit("-buildmode=plugin"),
				Line().Lit(fmt.Sprintf(
					"cmd/%s/main_gen.go",
					strcase.ToSnake(sdkConfig.ExtensionName),
				)),
				Line(),
			),
			Line(),

			Id("output").Op(",").Id("err").Op(":=").Id("buildCmd").Dot("CombinedOutput").Call(),
			If(Id("err").Op("!=").Nil()).Block(
				Return(Qual("fmt", "Errorf").Call(
					Lit("build failed for tptctl plugin with output '%s': %w"),
					Id("output"),
					Id("err"),
				)),
			),
			Line(),

			Qual("fmt", "Println").Call(Lit(fmt.Sprintf(
				"tptctl plugin built and available at bin/%s",
				strcase.ToKebab(sdkConfig.ExtensionName),
			))),
			Line(),

			Return(Nil()),
		)
		f.Line()
	}

	// API docs generation
	f.Comment("Docs generates the API server documentation that is served by the API")
	f.Func().Id("Docs").Params().Error().Block(
		Id("docsDestination").Op(":=").Lit("pkg/api-server/v0/docs"),
		Id("swagCmd").Op(":=").Qual("os/exec", "Command").Call(
			Line().Lit("swag"),
			Line().Lit("init"),
			Line().Lit("--dir"),
			Line().Lit("cmd/rest-api,pkg/api,pkg/api-server/v0"),
			Line().Lit("--parseDependency"),
			Line().Lit("--generalInfo"),
			Line().Lit("main_gen.go"),
			Line().Lit("--output"),
			Line().Id("docsDestination"),
			Line(),
		),
		Line(),

		List(Id("output"), Err()).Op(":=").Id("swagCmd").Dot("CombinedOutput").Call(),
		If(Err().Op("!=").Nil()).Block(
			Return(Qual("fmt", "Errorf").Call(Lit("API docs generation failed with output '%s': %w"), Id("output"), Err())),
		),
		Line(),

		Qual("fmt", "Printf").Call(Lit("API docs generated in %s\n"), Id("docsDestination")),
		Line(),

		Return(Nil()),
	)
	f.Line()

	// build vals utility function
	f.Comment("getBuildVals returns the working directory and arch for builds.")
	f.Func().Id("getBuildVals").Params().Params(
		String(),
		String(),
		Error(),
	).Block(
		List(Id("workingDir"), Err()).Op(":=").Qual("os", "Getwd").Call(),
		If(Err().Op("!=").Nil()).Block(
			Return(Lit(""), Lit(""), Qual("fmt", "Errorf").Call(Lit("failed to get working directory: %w"), Err())),
		),
		Line(),

		Id("arch").Op(":=").Qual("runtime", "GOARCH"),
		Line(),

		Return(Id("workingDir"), Id("arch"), Nil()),
	)

	// write code to file
	genFilepath := "magefile_gen.go"
	_, err := util.WriteCodeToFile(f, genFilepath, true)
	if err != nil {
		return fmt.Errorf("failed to write generated code to file %s: %w", genFilepath, err)
	}
	cli.Info(fmt.Sprintf("source code for magefile written to %s", genFilepath))

	return nil
}
