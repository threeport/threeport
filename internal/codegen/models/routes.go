package models

import (
	"fmt"
	"os"
	"path/filepath"

	. "github.com/dave/jennifer/jen"
	"github.com/gertd/go-pluralize"
	"github.com/iancoleman/strcase"

	"github.com/threeport/threeport/internal/codegen"
)

// apiRoutesPath returns the path from the models to the API's internal routes
// package.
func apiRoutesPath() string {
	return filepath.Join("..", "..", "..", "internal", "api", "routes")
}

// ModelRoutes generates the REST routes and maps them to their handlers.  These
// routes are assembled in route functions which are added to the echo server
// when the API starts.
func (cc *ControllerConfig) ModelRoutes() error {
	pluralize := pluralize.NewClient()
	f := NewFile("routes")
	f.HeaderComment("generated by 'threeport-codegen api-model' - do not edit")
	f.ImportAlias("github.com/labstack/echo/v4", "echo")
	for i, mc := range cc.ModelConfigs {
		routeFuncName := fmt.Sprintf("%sRoutes", mc.TypeName)
		mc.GetVersionHandlerName = fmt.Sprintf("Get%sVersions", mc.TypeName)
		mc.AddHandlerName = fmt.Sprintf("Add%s", mc.TypeName)
		mc.GetAllHandlerName = fmt.Sprintf("Get%s", pluralize.Pluralize(mc.TypeName, 2, false))
		mc.GetOneHandlerName = fmt.Sprintf("Get%s", mc.TypeName)
		mc.PatchHandlerName = fmt.Sprintf("Update%s", mc.TypeName)
		mc.PutHandlerName = fmt.Sprintf("Replace%s", mc.TypeName)
		mc.DeleteHandlerName = fmt.Sprintf("Delete%s", mc.TypeName)
		cc.ModelConfigs[i] = mc
		f.Comment(fmt.Sprintf(
			"%s sets up all routes for the %s handlers.", routeFuncName, mc.TypeName,
		))
		f.Func().Id(routeFuncName).Params(
			Id("e").Op("*").Qual(
				"github.com/labstack/echo/v4",
				"Echo",
			),
			Id("h").Op("*").Qual(
				"github.com/threeport/threeport/internal/api/handlers",
				"Handler",
			),
		).Block(
			Id("e").Dot("GET").Call(
				Lit(
					fmt.Sprintf("/%s/versions", pluralize.Pluralize(strcase.ToKebab(mc.TypeName), 2, false)),
				),
				Id("h").Dot(mc.GetVersionHandlerName),
			),
			Line(),
			Id("e").Dot("POST").Call(
				Qual(
					fmt.Sprintf(
						"github.com/threeport/threeport/pkg/api/%s",
						cc.ParsedModelFile.Name.Name,
					),
					fmt.Sprintf("Path%s", pluralize.Pluralize(mc.TypeName, 2, false)),
				),
				Id("h").Dot(mc.AddHandlerName),
			),
			Id("e").Dot("GET").Call(
				Qual(
					fmt.Sprintf(
						"github.com/threeport/threeport/pkg/api/%s",
						cc.ParsedModelFile.Name.Name,
					),
					fmt.Sprintf("Path%s", pluralize.Pluralize(mc.TypeName, 2, false)),
				),
				Id("h").Dot(mc.GetAllHandlerName),
			),
			Id("e").Dot("GET").Call(
				Qual(
					fmt.Sprintf(
						"github.com/threeport/threeport/pkg/api/%s",
						cc.ParsedModelFile.Name.Name,
					),
					fmt.Sprintf("Path%s", pluralize.Pluralize(mc.TypeName, 2, false)),
				).Op("+").Lit("/:id"),
				Id("h").Dot(mc.GetOneHandlerName),
			),
			Id("e").Dot("PATCH").Call(
				Qual(
					fmt.Sprintf(
						"github.com/threeport/threeport/pkg/api/%s",
						cc.ParsedModelFile.Name.Name,
					),
					fmt.Sprintf("Path%s", pluralize.Pluralize(mc.TypeName, 2, false)),
				).Op("+").Lit("/:id"),
				Id("h").Dot(mc.PatchHandlerName),
			),
			Id("e").Dot("PUT").Call(
				Qual(
					fmt.Sprintf(
						"github.com/threeport/threeport/pkg/api/%s",
						cc.ParsedModelFile.Name.Name,
					),
					fmt.Sprintf("Path%s", pluralize.Pluralize(mc.TypeName, 2, false)),
				).Op("+").Lit("/:id"),
				Id("h").Dot(mc.PutHandlerName),
			),
			Id("e").Dot("DELETE").Call(
				Qual(
					fmt.Sprintf(
						"github.com/threeport/threeport/pkg/api/%s",
						cc.ParsedModelFile.Name.Name,
					),
					fmt.Sprintf("Path%s", pluralize.Pluralize(mc.TypeName, 2, false)),
				).Op("+").Lit("/:id"),
				Id("h").Dot(mc.DeleteHandlerName),
			),
		)
	}

	// write code to file
	genFilename := fmt.Sprintf("%s_gen.go", codegen.FilenameSansExt(cc.ModelFilename))
	genFilepath := filepath.Join(apiRoutesPath(), genFilename)
	file, err := os.OpenFile(genFilepath, os.O_CREATE|os.O_WRONLY|os.O_TRUNC, 0644)
	if err != nil {
		return fmt.Errorf("failed open file to write generated code for model routes: %w", err)
	}
	defer file.Close()
	if err := f.Render(file); err != nil {
		return fmt.Errorf("failed to render generated source code for model routes: %w", err)
	}
	fmt.Printf("code generation complete for %s model routes\n", cc.ControllerDomainLower)

	return nil
}
