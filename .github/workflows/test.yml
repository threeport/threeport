name: Test

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize
      - reopened

jobs:
  test:
    runs-on: ubuntu-22.04
    steps:

    - name: Check out code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Install mage
      run: go install github.com/magefile/mage@latest

    - name: Create local container registry
      run: mage createLocalRegistry

    - name: Build control plane component binaries
      run: mage buildAll

    - name: Build agent binary
      run: mage buildAgent

    - name: Build DB migrator binary
      run: mage buildDatabaseMigrator

    - name: Build and push control plane component images
      run: mage buildAllImages

    - name: Build and push agent image
      run: mage buildAgentImage

    - name: Build DB migrator image
      run: mage buildDatabaseMigratorImage

    - name: Build tptctl
      run: mage buildTptctl

    - name: Create test control plane
      run: bin/tptctl up -r localhost:5001 -t dev -n dev-0 --local-registry

    - name: Run tests
      run: go test -v ./test/integration -count=1

